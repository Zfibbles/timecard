<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wirtz Electric Time Card</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 15px;
        background: #f4f4f4;
    }

    h2 {
        text-align: center;
        font-size: 18px;
        margin-bottom: 10px;
        line-height: 1.3;
    }

    #weekTabs {
        display: flex;
        gap: 5px;
        margin-bottom: 10px;
    }

    .week-tab {
        flex: 1;
        padding: 8px;
        font-size: 12px;
        border-radius: 6px;
        border: none;
        background: #ddd;
    }

    .week-tab.active {
        background: #004aad;
        color: #fff;
        font-weight: bold;
    }

    #weekLabel {
        text-align: center;
        font-size: 12px;
        margin-bottom: 8px;
        color: #555;
    }

    #jobs {
        margin-top: 10px;
    }

    .job-card {
        background: white;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        position: relative;
    }

    .week-note {
        display: inline-block;
        background: #ffeb3b;
        color: #000;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 11px;
        margin-top: 4px;
    }

    /* ⭐ SAFARI FIX — prevents collapsing inputs */
    .row {
        display: flex;
        gap: 8px;
        margin-bottom: 8px;
        min-width: 0;
    }

    .row input {
        flex: 1 1 auto;
        min-width: 0;
        padding: 8px;
        font-size: 14px;
    }

    .remove-btn {
        background: #b30000;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 5px;
        font-size: 12px;
        margin-top: 5px;
    }

    #addBtn, .action-btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        margin-top: 10px;
    }

    #addBtn {
        background: #004aad;
        color: white;
    }

    #printBtn {
        background: #ffd60a;
        color: #000;
    }

    #emailBtn {
        background: #007bff;
        color: white;
    }

    #totals {
        margin-top: 15px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
    }

    #totals input {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        font-size: 14px;
    }

    @media print {
        #addBtn, #printBtn, #emailBtn, .remove-btn, #weekTabs {
            display: none;
        }
        body {
            background: white;
        }
        .job-card {
            box-shadow: none;
            border: 1px solid #ccc;
        }
    }
</style>

</head>
<body>

<h2>WIRTZ ELECTRIC & COMMUNICATIONS<br>MUSKEGON, MI</h2>

<div id="weekTabs">
    <button class="week-tab active" data-week="0">This Week</button>
    <button class="week-tab" data-week="1">Last Week</button>
    <button class="week-tab" data-week="2">2 Weeks Ago</button>
    <button class="week-tab" data-week="3">3 Weeks Ago</button>
</div>

<div id="weekLabel"></div>

<div id="jobs"></div>

<button id="addBtn">Add Job</button>

<div id="totals">
    <strong>Total Hours</strong>
    <input id="totalHours" readonly>

    <strong>Total OT Hours</strong>
    <input id="totalOT" readonly>
</div>

<button id="printBtn" class="action-btn" onclick="window.print()">Print / Save PDF</button>
<button id="emailBtn" class="action-btn" onclick="emailReport()">Email Time Card</button>

<script>
let allJobs = {0: [], 1: [], 2: [], 3: []};
let selectedWeek = 0;
let jobIdCounter = 1;

/* ---------- DATE HELPERS ---------- */

function safeParseDate(str) {
    return new Date(str.replace(/-/g, "/"));
}

function getMonday(d) {
    const date = new Date(d);
    const day = date.getDay();
    const diff = (day === 0 ? -6 : 1 - day);
    date.setDate(date.getDate() + diff);
    date.setHours(0,0,0,0);
    return date;
}

function getWeekIndexFromDateStr(dateStr) {
    if (!dateStr) return null;
    const parsed = safeParseDate(dateStr);
    if (isNaN(parsed)) return null;

    const today = new Date();
    const currentMonday = getMonday(today);
    const targetMonday = getMonday(parsed);

    const diffMs = currentMonday - targetMonday;
    const diffDays = diffMs / (1000 * 60 * 60 * 24);
    const diffWeeks = Math.round(diffDays / 7);

    if (diffWeeks >= 0 && diffWeeks <= 3) return diffWeeks;
    return null;
}

function getWeekRangeLabel(weekIndex) {
    const today = new Date();
    const currentMonday = getMonday(today);
    const monday = new Date(currentMonday);
    monday.setDate(monday.getDate() - 7 * weekIndex);
    const sunday = new Date(monday);
    sunday.setDate(sunday.getDate() + 6);

    const opts = {month: 'short', day: 'numeric'};
    return `${monday.toLocaleDateString(undefined, opts)} - ${sunday.toLocaleDateString(undefined, opts)}`;
}

/* ---------- STORAGE ---------- */

function saveData() {
    localStorage.setItem("timecard_allJobs", JSON.stringify(allJobs));
}

function loadData() {
    const saved = JSON.parse(localStorage.getItem("timecard_allJobs"));
    if (saved) allJobs = saved;
}

/* ---------- UI RENDERING ---------- */

function renderWeekLabel() {
    document.getElementById("weekLabel").textContent = getWeekRangeLabel(selectedWeek);
}

function renderJobs() {
    const container = document.getElementById("jobs");
    container.innerHTML = "";

    const jobs = allJobs[selectedWeek] || [];
    jobs.forEach(job => {
        const card = document.createElement("div");
        card.className = "job-card";
        card.dataset.jobId = job.id;

        const weekIndex = job.date ? getWeekIndexFromDateStr(job.date) : selectedWeek;
        const moved = weekIndex !== selectedWeek && weekIndex !== null;

        card.innerHTML = `
            <div class="row">
                <input type="date" value="${job.date}" onchange="onDateChange(this)">
                <input type="text" inputmode="latin-prose" pattern="[0-9A-Za-z]*" placeholder="Job #" value="${job.job}">
            </div>

            ${moved ? `<div><span class="week-note">(Moved to ${weekIndex === 1 ? "Last Week" : weekIndex + " Weeks Ago"})</span></div>` : ""}

            <div class="row">
                <input type="text" placeholder="Description" value="${job.desc}">
            </div>

            <div class="row">
                <input type="tel" inputmode="decimal" placeholder="Hours" value="${job.hours}">
                <input type="tel" inputmode="decimal" placeholder="OT" value="${job.ot}">
            </div>

            <button class="remove-btn" onclick="removeJob(this)">Remove</button>
        `;

        const inputs = card.querySelectorAll("input");
        inputs.forEach(input => {
            input.addEventListener("input", () => handleInputChange(card));
            input.addEventListener("change", () => handleInputChange(card));
        });

        container.appendChild(card);
    });

    updateTotals();
}

function handleInputChange(card) {
    const jobId = parseInt(card.dataset.jobId, 10);
    const inputs = card.querySelectorAll("input");

    const date = inputs[0].value;
    const job = inputs[1].value;
    const desc = inputs[2].value;
    const hours = inputs[3].value;
    const ot = inputs[4].value;

    const weekIndex = date ? getWeekIndexFromDateStr(date) : selectedWeek;

    if (date && weekIndex === null) {
        alert("Date is outside the last 3 weeks or in the future. Entry not stored.");
        inputs[0].value = "";
        return;
    }

    let jobObj = null;
    let foundWeek = null;

    for (let w = 0; w <= 3; w++) {
        const idx = allJobs[w].findIndex(j => j.id === jobId);
        if (idx !== -1) {
            foundWeek = w;
            jobObj = allJobs[w][idx];

            if (weekIndex !== null && weekIndex !== w) {
                allJobs[w].splice(idx, 1);
                allJobs[weekIndex].push(jobObj);
            }
            break;
        }
    }

    if (!jobObj) return;

    jobObj.date = date;
    jobObj.job = job;
    jobObj.desc = desc;
    jobObj.hours = hours;
    jobObj.ot = ot;

    saveData();
    renderJobs();
}

function onDateChange(input) {
    const card = input.closest(".job-card");
    handleInputChange(card);
}

/* ---------- JOB OPERATIONS ---------- */

function addJob() {
    const newJob = {
        id: jobIdCounter++,
        date: "",
        job: "",
        desc: "",
        hours: "",
        ot: ""
    };
    allJobs[selectedWeek].push(newJob);
    saveData();
    renderJobs();
}

function removeJob(btn) {
    const card = btn.parentElement;
    const jobId = parseInt(card.dataset.jobId, 10);

    const jobs = allJobs[selectedWeek];
    const idx = jobs.findIndex(j => j.id === jobId);
    if (idx !== -1) jobs.splice(idx, 1);

    card.remove();
    saveData();
    updateTotals();
}

/* ---------- TOTALS + EMAIL ---------- */

function updateTotals() {
    let total = 0;
    let totalOT = 0;

    const jobs = allJobs[selectedWeek] || [];
    jobs.forEach(job => {
        total += parseFloat(job.hours) || 0;
        totalOT += parseFloat(job.ot) || 0;
    });

    document.getElementById("totalHours").value = total.toFixed(1);
    document.getElementById("totalOT").value = totalOT.toFixed(1);

    saveData();
}

function emailReport() {
    const jobs = allJobs[selectedWeek] || [];
    let total = document.getElementById("totalHours").value;
    let totalOT = document.getElementById("totalOT").value;

    let body = `Time Card Summary (%0D%0A${getWeekRangeLabel(selectedWeek)}):%0D%0A
Total Hours: ${total}%0D%0A
Total OT Hours: ${totalOT}%0D%0A%0D%0A
Jobs:%0D%0A`;

    jobs.forEach((job, i) => {
        body += `Job ${i+1}:%0D%0A`;
        body += `Date: ${job.date}%0D%0A`;
        body += `Job #: ${job.job}%0D%0A`;
        body += `Description: ${job.desc}%0D%0A`;
        body += `Hours: ${job.hours}%0D%0A`;
        body += `OT: ${job.ot}%0D%0A%0D%0A`;
    });

    window.location.href = `mailto:?subject=Time Card&body=${body}`;
}

/* ---------- WEEK TAB HANDLING ---------- */

function setActiveTab(weekIndex) {
    selectedWeek = weekIndex;
    document.querySelectorAll(".week-tab").forEach(btn => {
        btn.classList.toggle("active", parseInt(btn.dataset.week, 10) === weekIndex);
    });
    renderWeekLabel();
    renderJobs();
}

/* ---------- INIT ---------- */

document.getElementById("addBtn").addEventListener("click", addJob);

document.querySelectorAll(".week-tab").forEach(btn => {
    btn.addEventListener("click", () => {
        const w = parseInt(btn.dataset.week, 10);
        setActiveTab(w);
    });
});

loadData();
renderWeekLabel();
renderJobs();
</script>

</body>
</html>
